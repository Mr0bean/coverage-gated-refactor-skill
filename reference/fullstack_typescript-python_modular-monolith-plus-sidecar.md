# fullstack_typescript-python_modular-monolith-plus-sidecar

## 适用场景

- 主体为 TypeScript/Next.js 模块化单体，辅以 Python 侧车微服务

## 重构思路

1. 主干优先：先稳定 Next.js 主体模块边界，再收敛 Python 侧车调用边界。
2. 契约先行：定义 TS <-> Python 接口协议（请求/响应/错误）并固化测试。
3. 分阶段拆分：按业务域逐块重构，避免一次性大迁移。
4. 跨栈解耦：把跨语言调用收敛到 adapter 层，避免横向扩散。
5. 链路可观测：以请求链路为主线设计日志和指标。

## 合规思路

1. 跨服务调用合规：超时、重试、熔断、降级策略可审计。
2. 数据流合规：明确跨边界数据类型与敏感字段处理规则。
3. 变更可回滚：每次重构保持回滚点，防止跨栈故障放大。
4. 责任边界合规：明确 TS 服务与 Python 服务的职责归属。
5. 依赖合规：双栈依赖都要纳入版本和漏洞治理流程。

## 规范清单

1. 边界规范：跨栈调用必须经统一 gateway/adapter。
2. 契约规范：请求/响应 schema 版本化管理。
3. 超时规范：每条跨服务调用必须定义 timeout。
4. 重试规范：仅对幂等调用允许自动重试。
5. 降级规范：下游不可用时必须有可解释降级路径。
6. 观测规范：trace id 必须贯穿前端/API/Python。
7. 测试规范：端到端测试覆盖关键业务路径。
8. 发布规范：跨栈变更使用灰度发布或分批验证。

## 可参考操作方法

1. 建契约：先整理 TS 与 Python 的 API 合同文档。
2. 加适配层：创建统一 client 封装超时、重试、错误转换。
3. 补链路日志：在入口、调用点、返回点记录 trace id。
4. 建 E2E：新增前端到 Python 的关键链路回归用例。
5. 分段重构：先无行为变更抽离，再进行架构优化。
6. 灰度发布：按模块或流量分组上线并观察关键指标。
7. 故障演练：模拟 Python 不可用验证降级和恢复策略。

## 最佳实践

1. 单体内模块化：领域边界、依赖方向、公共契约统一管理。
2. 侧车服务最小化：只保留确有必要的 Python 能力（如 PDF 转换）。
3. 端到端测试：覆盖前端 -> API -> Python 服务的关键链路。
4. 可观测性：统一 trace/log 关联 ID，便于跨栈排障。
5. 技术债管理：记录跨栈耦合点并按优先级逐步清理。
