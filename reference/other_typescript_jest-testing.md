# other_typescript_jest-testing

## 适用场景

- 其他模块（工具函数、适配层、脚本）及测试体系重构

## 重构思路

1. 测试先行：先补 contract/regression tests，再做结构调整。
2. 工具模块纯函数化：把可变状态与 I/O 隔离到边界层。
3. 小步提交：每次只处理一个模块或一个风险点。
4. 测试分层：单元、集成、端到端边界清晰。
5. 先稳定 flaky tests，再推进大规模重构。

## 合规思路

1. 测试数据合规：避免使用真实敏感数据作为夹具。
2. 日志与快照合规：输出内容脱敏，避免泄露密钥和身份信息。
3. 变更证据合规：保留覆盖率与回归结果用于审计追踪。
4. 工具脚本合规：脚本执行范围和副作用必须可控。
5. 报告合规：失败日志需可追踪但不泄露生产敏感信息。

## 规范清单

1. 测试命名规范：用例名体现行为，不体现实现细节。
2. 断言规范：优先行为断言，减少脆弱快照依赖。
3. 覆盖率规范：模块门禁 90%+（statements/lines）。
4. 环境规范：固定时区、随机种子、系统时间控制策略。
5. Mock 规范：仅 mock 边界依赖，不 mock 被测核心逻辑。
6. 清理规范：每个测试后恢复全局状态与 mock。
7. 分层规范：单元测试快、集成测试稳、E2E 精选关键路径。
8. 报告规范：覆盖率与失败报告可长期留档。

## 可参考操作方法

1. 建测试资产清单：按模块梳理缺失的测试类型。
2. 先补契约用例：补输入验证、边界值、错误路径。
3. 清理 flaky：替换不稳定计时器和异步等待方式。
4. 统一工具：抽公共 test helpers、fixture builders。
5. 建门禁：CI 中接入覆盖率阈值和关键套件强制通过。
6. 逐模块重构：每改一块立即跑模块测试与全量回归。
7. 发布留证：归档覆盖率报告和回归结论。

## 最佳实践

1. Jest 分层：单元测试覆盖工具逻辑，集成测试覆盖模块协作。
2. 覆盖率门禁：模块级 90%+（statements/lines）再进入重构。
3. 脆弱测试治理：减少对实现细节快照依赖，偏重行为断言。
4. 稳定执行：固定测试环境、时区与随机性。
5. 高风险模块优先补测：认证、权限、数据写入、跨服务调用。
