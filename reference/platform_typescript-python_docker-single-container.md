# platform_typescript-python_docker-single-container

## 适用场景

- Next.js + Python 微服务共容器部署（当前 `Dockerfile`）

## 重构思路

1. 明确进程边界：Node 与 Python 进程启动、存活、退出策略可观测。
2. 配置集中化：端口、服务地址、资源限制通过环境变量管理。
3. 构建分层优化：依赖层与源码层分离，提升缓存命中与发布效率。
4. 启动链可靠化：避免“一个进程退出但容器仍假活着”的风险。
5. 逐步平台化：从单容器并行进程过渡到更稳健的编排方案。

## 合规思路

1. 供应链合规：基础镜像与依赖版本固定并定期扫描。
2. 运行时合规：最小权限运行、避免把敏感配置写进镜像。
3. 安全暴露面：仅暴露必要端口，限制调试能力进入生产。
4. 变更合规：镜像与部署变更需可追溯和可回滚。
5. 配置合规：环境变量分级管理，禁止明文硬编码凭据。

## 规范清单

1. 镜像规范：多阶段构建，运行层仅保留必要运行时。
2. 用户规范：容器内非 root 运行。
3. 健康检查规范：Node 与 Python 双健康检查。
4. 日志规范：统一 stdout/stderr，结构化日志优先。
5. 资源规范：设置 CPU/内存限制和重启策略。
6. 网络规范：仅暴露必要端口，内部调用走内网地址。
7. 安全规范：开启基础镜像和依赖漏洞扫描。
8. 回滚规范：保留最近稳定镜像标签和回滚脚本。

## 可参考操作方法

1. 拆分启动：使用 entrypoint 脚本显式管理双进程启动顺序。
2. 加探针：实现 `/healthz` 与 Python 健康端点并绑定容器健康检查。
3. 强化镜像：锁定基础镜像 digest，减少漂移。
4. 统一配置：将端口、URL、并发参数迁移到环境变量。
5. 演练故障：模拟 Python 进程崩溃与自动重启策略。
6. 发布验证：构建后执行 smoke tests 覆盖前端与 PDF 服务链路。
7. 回滚演练：验证镜像版本回退可在规定时间内完成。

## 最佳实践

1. 优先使用进程管理方案（supervisor/s6/sidecar编排）替代简单后台并行命令。
2. 健康检查覆盖双进程（Node、Python）并支持优雅关闭。
3. 构建产物最小化：移除无关文件，减小镜像体积。
4. 发布门禁：构建成功 + 健康检查 + 关键接口回归测试。
5. 发布后监控：重点观察启动失败率、错误率、处理延时。
