# backend_typescript_nextjs-route-handlers

## 适用场景

- Next.js `app/api/**/route.ts` 路由处理器重构

## 重构思路

1. Handler 轻量化：参数解析、业务逻辑、存储访问拆到 `_route-utils.ts` 或 service 层。
2. 统一错误模型：标准化错误码、错误消息和 HTTP 状态码映射。
3. 强化可测试性：把副作用（文件系统、网络）注入边界，便于 mock。
4. 收敛接口契约：统一请求 DTO 与响应 DTO，减少自由字段。
5. 幂等与重试友好：对可重试接口定义幂等规则和冲突策略。

## 合规思路

1. 鉴权与权限：敏感接口必须有身份校验与最小权限控制。
2. 输入校验：请求参数白名单校验，拒绝隐式类型转换和越权字段。
3. 审计与日志：记录必要审计信息，避免记录凭据、令牌和隐私内容。
4. 数据暴露最小化：响应字段按最小必要原则输出。
5. 异常处理合规：错误返回不泄露数据库路径、堆栈、内部类名。

## 规范清单

1. 路由规范：每个 handler 文件仅保留薄入口和状态码映射。
2. DTO 规范：入参、出参、内部模型分离，禁止混用。
3. 错误规范：统一 error code 字典，禁止散乱字符串错误。
4. 鉴权规范：鉴权逻辑下沉中间层，避免每个 handler 重复拼装。
5. 日志规范：请求 ID、用户 ID、资源 ID 为标准上下文字段。
6. 时区规范：时间字段统一 ISO 8601（UTC）。
7. 兼容规范：已有响应字段默认向后兼容，不随意删改。
8. 注释规范：跨边界逻辑（权限/事务/重试）必须注释说明。

## 可参考操作方法

1. 建立路由清单：按资源列出所有 `route.ts` 及其输入输出。
2. 抽取共性校验：把参数校验提炼为公共 validator。
3. 抽取业务逻辑：把每个 handler 中业务逻辑迁入 service/util。
4. 统一错误映射：实现 `domain error -> http status` 映射表。
5. 补全测试：新增成功/失败/越权/边界四类测试。
6. 回归与基线对比：对比 refactor 前后响应体和状态码快照。
7. 文档落地：更新 API 契约文档和错误码文档。

## 最佳实践

1. 路由层只做：入参解析、调用 service、出参格式化。
2. 数据契约固定：响应 schema 稳定，向后兼容优先。
3. 失败可观测：错误日志带请求上下文（不含敏感信息）。
4. 测试门禁：接口级回归测试覆盖成功/失败/边界路径。
5. 关键接口补充幂等策略和速率限制策略。
6. 把高风险路径（写操作）加入审计字段校验。
